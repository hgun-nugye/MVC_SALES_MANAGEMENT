CREATE DATABASE DB_QLBH;
GO
USE DB_QLBH;
GO

CREATE TABLE Tinh (
    MaTinh SMALLINT PRIMARY KEY,
	TenTinh NVARCHAR(50) NOT NULL
);
GO

CREATE TABLE Xa (
    MaXa SMALLINT PRIMARY KEY,
	TenXa NVARCHAR(50) NOT NULL,
	MaTinh SMALLINT NOT NULL,
	CONSTRAINT FK_Xa_Tinh FOREIGN KEY (MaTinh)
        REFERENCES Tinh(MaTinh) ON DELETE CASCADE
);
GO

CREATE TABLE Nuoc (
    MaNuoc CHAR(5) PRIMARY KEY,
    TenNuoc NVARCHAR(100) NOT NULL
);
GO

CREATE TABLE HangSX (
    MaHangSX CHAR(5) PRIMARY KEY,
    TenHangSX NVARCHAR(100) NOT NULL,
    MaNuoc CHAR(5) NOT NULL,
    CONSTRAINT FK_HangSX_Nuoc FOREIGN KEY (MaNuoc)
        REFERENCES Nuoc(MaNuoc)
);
GO

CREATE TABLE NhaCC (
    MaNCC VARCHAR(10) PRIMARY KEY,
    TenNCC NVARCHAR(100) NOT NULL,
    DienThoaiNCC VARCHAR(15) NOT NULL,
    EmailNCC VARCHAR(100),
    DiaChiNCC NVARCHAR(255) NOT NULL,
	MaXa SMALLINT NOT NULL,
	CONSTRAINT FK_Xa_NhaCC FOREIGN KEY (MaXa)
        REFERENCES Xa(MaXa)
);
GO

CREATE TABLE KhachHang(
    MaKH VARCHAR(10) PRIMARY KEY,
    TenKH NVARCHAR(100) NOT NULL,
    AnhKH NVARCHAR(255),
    GioiTinh BIT,
    EmailKH NVARCHAR(255),
    DienThoaiKH VARCHAR(10) NOT NULL,
    DiaChiKH NVARCHAR(255),
	TenDNKH VARCHAR(50) NOT NULL,
    MatKhauKH VARCHAR(255) NOT NULL,
	MaXa SMALLINT,
	CONSTRAINT FK_Xa_KhachHang FOREIGN KEY (MaXa)
        REFERENCES Xa(MaXa)
);
GO

CREATE TABLE VaiTro(
	MaVT CHAR(5) PRIMARY KEY,
	TenVT NVARCHAR(50) NOT NULL
);
GO

CREATE TABLE NhanVien (
    MaNV VARCHAR(10) PRIMARY KEY,
	CCCD VARCHAR(12) NOT NULL,
    TenNV NVARCHAR(100) NOT NULL,
	GioiTinh BIT NOT NULL,
	NgaySinh DATE,
	SDT VARCHAR(10) NOT NULL,
	Email VARCHAR(50),
	NgayLam DATE DEFAULT GETDATE(),
    AnhNV NVARCHAR(255),
	DiaChiNV NVARCHAR(255) NOT NULL,
	MaXa SMALLINT NOT NULL,

    TenDNNV VARCHAR(50) NOT NULL,
    MatKhauNV VARCHAR(255) NOT NULL,

	CONSTRAINT FK_Xa_NhanVien FOREIGN KEY (MaXa)
        REFERENCES Xa(MaXa)
);
GO

CREATE TABLE PhanQuyen(
	MaVT CHAR(5) NOT NULL,
	MaNV VARCHAR(10) NOT NULL,
	CONSTRAINT PK_PhanQuyen PRIMARY KEY (MaVT, MaNV),
	CONSTRAINT FK_PQ_VaiTro FOREIGN KEY (MaVT)
		REFERENCES VaiTro(MaVT),
	CONSTRAINT FK_PQ_NhanVien FOREIGN KEY (MaNV)
		REFERENCES NhanVien(MaNV)
);
GO

CREATE TABLE NhomSP (
    MaNhom VARCHAR(10) PRIMARY KEY,
    TenNhom NVARCHAR(100) NOT NULL
);
GO

CREATE TABLE LoaiSP(
    MaLoai VARCHAR(10) PRIMARY KEY,
    TenLoai NVARCHAR(50) NOT NULL,
    MaNhom VARCHAR(10) NOT NULL,
    CONSTRAINT FK_LoaiSP_NhomSP FOREIGN KEY (MaNhom)
        REFERENCES NhomSP(MaNhom)
);
GO

CREATE TABLE TrangThai(
	MaTT CHAR(3) PRIMARY KEY,
	TenTT NVARCHAR(50) NOT NULL
);
GO

CREATE TABLE SanPham(
    MaSP VARCHAR(10) PRIMARY KEY,
    TenSP NVARCHAR(50) NOT NULL,
    GiaBan DECIMAL(18,2) NOT NULL,
    MoTaSP NVARCHAR(MAX) NOT NULL,
    AnhMH NVARCHAR(255),

    ThanhPhan NVARCHAR(MAX) NOT NULL,
    CongDung NVARCHAR(MAX) NOT NULL,
    HDSD NVARCHAR(MAX) NOT NULL,
    HDBaoQuan NVARCHAR(MAX) NOT NULL,
    TrongLuong DECIMAL(5,2) NOT NULL,

	MaTT CHAR(3) NOT NULL,
    MaLoai VARCHAR(10) NOT NULL,
	MaHangSX CHAR(5) NOT NULL,
	CONSTRAINT FK_SanPham_Hang FOREIGN KEY (MaHangSX)
		REFERENCES HangSX(MaHangSX),
    CONSTRAINT FK_SanPham_LoaiSP FOREIGN KEY (MaLoai)
        REFERENCES LoaiSP(MaLoai),
	CONSTRAINT FK_SanPham_TrangThai FOREIGN KEY (MaTT)
        REFERENCES TrangThai(MaTT)
);
GO

CREATE TABLE TrangThaiBH (
    MaTTBH CHAR(3) PRIMARY KEY,
    TenTTBH NVARCHAR(50) NOT NULL 
);
GO

CREATE TABLE TrangThaiMH (
    MaTTMH CHAR(3) PRIMARY KEY,
    TenTTMH NVARCHAR(50) NOT NULL 
);
GO

CREATE TABLE DonMuaHang(
    MaDMH CHAR(11) PRIMARY KEY,
    NgayMH DATE NOT NULL,
    MaNCC VARCHAR(10) NOT NULL,
	MaNV VARCHAR(10) NOT NULL,
	MaTTMH CHAR(3) NOT NULL,

    CONSTRAINT FK_DonMuaHang_NhaCC FOREIGN KEY (MaNCC)
        REFERENCES NhaCC(MaNCC),
	CONSTRAINT FK_DonMuaHang_NhanVien FOREIGN KEY (MaNV)
    REFERENCES NhanVien(MaNV),
	CONSTRAINT FK_DonMuaHang_TrangThaiMH FOREIGN KEY (MaTTMH)
        REFERENCES TrangThaiMH(MaTTMH)
);
GO

CREATE TABLE DonBanHang(
    MaDBH CHAR(11) PRIMARY KEY,
    NgayBH DATE NOT NULL,
    MaKH VARCHAR(10) NOT NULL,
	DiaChiDBH NVARCHAR(255) NOT NULL,
	MaXa SMALLINT NOT NULL,
	MaTTBH CHAR(3) NOT NULL,
	CONSTRAINT FK_Xa_DonBanHang FOREIGN KEY (MaXa)
        REFERENCES Xa(MaXa),
    CONSTRAINT FK_DonBanHang_KhachHang FOREIGN KEY (MaKH)
        REFERENCES KhachHang(MaKH),
	CONSTRAINT FK_DonBanHang_TrangThaiBH FOREIGN KEY (MaTTBH)
        REFERENCES TrangThaiBH(MaTTBH)
);
GO

CREATE TABLE CTMH(
    MaDMH CHAR(11) NOT NULL,
    MaSP VARCHAR(10) NOT NULL,
    SLM INT NOT NULL,
    DGM DECIMAL(18,2) NOT NULL,
    CONSTRAINT PK_CTMH PRIMARY KEY(MaDMH, MaSP),
    CONSTRAINT FK_CTMH_DonMuaHang FOREIGN KEY (MaDMH)
        REFERENCES DonMuaHang(MaDMH) ON DELETE CASCADE,
    CONSTRAINT FK_CTMH_SanPham FOREIGN KEY (MaSP)
        REFERENCES SanPham(MaSP)
);
GO

CREATE TABLE CTBH(
    MaDBH CHAR(11) NOT NULL,
    MaSP VARCHAR(10) NOT NULL,
    SLB INT NOT NULL,
    DGB DECIMAL(18,2) NOT NULL,
    CONSTRAINT PK_CTBH PRIMARY KEY(MaDBH, MaSP),
    CONSTRAINT FK_CTBH_DonBanHang FOREIGN KEY (MaDBH)
        REFERENCES DonBanHang(MaDBH) ON DELETE CASCADE,
    CONSTRAINT FK_CTBH_SanPham FOREIGN KEY (MaSP)
        REFERENCES SanPham(MaSP)
);
GO
